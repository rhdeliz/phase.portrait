```markdown
# phase.portrait

<!-- badges: start -->
  <!-- badges: end -->
  
  **phase.portrait** is a comprehensive toolkit designed to facilitate the analysis and visualization of phase space dynamics. This package is ideal for exploring complex systems through phase portraits, trajectories, and streamlines, providing flexible options for both standard and fraction-based data representations. With **phase.portrait**, you can create detailed phase plots, analyze variable relationships over pseudotime, and produce insightful visual summaries through customizable options for binning, parallel processing, and saving.

## Installation

To install the development version of **phase.portrait** from GitHub, use the following command:
  
  ```r
# Install from GitHub
# Uncomment and run the following line if using devtools:
# devtools::install_github("rhdeliz/phase.portrait")
```

## Overview

The `run_analysis` function is the primary function in **phase.portrait**. It allows users to perform a complete analysis on a dataset, generating phase portraits, trajectory plots, streamlines, and other visualizations based on user-defined parameters.

### Main Features

- **Phase Space Calculation**: Calculate and visualize phase spaces with support for parallel processing.
- **Flexible Plotting Options**: Create standard and fraction-based plots with options for binning, axis limits, and combined or individual outputs.
- **Customizable Visuals**: Choose from various plot types, including trajectory plots, stream plots, phase portraits, and n-count plots.
- **Error Handling and Parallel Processing**: Supports parallel processing and includes comprehensive error handling to streamline large dataset analyses.

### Input Requirements for Analysis

The package expects an input data frame containing key columns that capture the time evolution and dynamic behavior of two variables (e.g., predator and prey populations) across various experimental or simulated conditions. Each row in the data frame represents an observation at a given point in time (`pseudotime`) for one of the variables (`variable`).

#### Required Columns

| Column      | Type       | Description                                                                                 |
  |-------------|------------|---------------------------------------------------------------------------------------------|
  | **pseudotime** | Numeric    | Represents the sequential time progression of the simulation or observation.                 |
  | **condition** | Character  | Specifies the parameters or settings used in each run of the model, allowing comparison across different conditions. |
  | **sample**    | Character  | Unique identifier for each initial condition of the simulation (formatted as `prey_population`_`predator_population`). |
  | **variable**  | Character  | Indicates the type of variable being measured, such as `"Predator"` or `"Prey"`.               |
  | **value**     | Numeric    | Indicates the value of the variable (`variable`) at the given time (`pseudotime`).            |
  
  This structure is essential for compatibility with downstream analysis and visualization functions, enabling **phase.portrait** to generate detailed phase portraits, trajectories, and streamline plots that illustrate system dynamics over time.

### Example Input

An example input, as generated by the `lotka_volterra()` function, is shown below:
  
  | pseudotime | condition               | sample | variable | value          |
  |------------|-------------------------|--------|----------|----------------|
  | 0.0        | a=0.5 b=0.8 c=1 d=0.8   | 1_1    | Predator | 1.0000000000   |
  | 0.0        | a=0.5 b=0.8 c=1 d=0.8   | 1_1    | Prey     | 1.0000000000   |
  | 0.1        | a=0.5 b=0.8 c=1 d=0.8   | 1_1    | Predator | 0.9790577093   |
  | 0.1        | a=0.5 b=0.8 c=1 d=0.8   | 1_1    | Prey     | 0.9712467742   |
  | 0.2        | a=0.5 b=0.8 c=1 d=0.8   | 1_1    | Predator | 0.9564415910   |
  | ...        | ...                     | ...    | ...      | ...            |
  | 24.8       | a=0.75 b=0.8 c=1 d=0.8  | 10_5   | Prey     | 0.004069663    |
  | 24.9       | a=0.75 b=0.8 c=1 d=0.8  | 10_5   | Predator | 0.017353235    |
  | 24.9       | a=0.75 b=0.8 c=1 d=0.8  | 10_5   | Prey     | 0.004380227    |
  | 25.0       | a=0.75 b=0.8 c=1 d=0.8  | 10_5   | Predator | 0.015707568    |
  | 25.0       | a=0.75 b=0.8 c=1 d=0.8  | 10_5   | Prey     | 0.004715143    |
  
  This format allows the package to perform comprehensive analyses on each unique condition, facilitating accurate, condition-specific phase space visualizations.

## Manual
View the documentation [here](https://github.com/rhdeliz/phase.portrait/blob/main/phase.portrait_0.0.0.0000.pdf)

## Example output
![Predator-Prey Combined Plot](Predator%20Prey_combined_plot.png)

## Example Usage

The example below demonstrates how to use **phase.portrait** to generate phase portraits and visualize data over pseudotime.

```r
# Define the base path where analysis results will be saved
save_path <- "~/Documents/phase_portrait_analysis"
bin_width <- 0.1

# Set the working directory to the parent directory of the save path
setwd(dirname(save_path))
dir.create(save_path, showWarnings = FALSE)

# Create a subdirectory for storing results based on bin width
save_path <- file.path(save_path, paste("bin_width", bin_width))
dir.create(save_path, showWarnings = FALSE)
setwd(save_path)

# Generate an example dataset by combining two sets of data with different parameters
# `lotka_volterra()` generates synthetic data for phase portrait analysis
example_dataset <- rbind(lotka_volterra(), lotka_volterra(alpha = 0.75))

# Scale and compute the difference of the dataset to prepare for analysis
d_table <- scale_and_diff(example_dataset)

# Run the analysis with specified parameters
run_analysis(
  df = d_table,          # Input data frame
  option = "all",        # Comprehensive analysis including standard and fraction-based options
  bin_width = bin_width, # Bin width for phase line calculations
  min_bin_n = 1,         # Minimum number of observations per bin
  save_tables = TRUE,    # Save intermediary data tables
  plot_individual = TRUE # Save each plot individually
)
```

The `run_analysis` function allows for high-level control over data analysis, enabling users to generate various types of plots and tables based on input parameters. Hereâ€™s a brief explanation of key parameters:
  
  - **`option`**: Specifies the type of analysis. Options are:
  - `"all"`: Perform a comprehensive analysis, generating both standard and fraction-based plots.
- `"standard"`: Generate only standard plots.
- `"fraction"`: Generate only fraction-based plots.
- **`bin_width`**: Defines the bin size for phase line calculations, which affects how data points are grouped in the plots.
- **`min_bin_n`**: Sets the minimum number of data points required per bin, filtering out bins with fewer observations.
- **`save_tables`**: If `TRUE`, saves intermediary tables generated during analysis.
- **`plot_individual`**: If `TRUE`, saves each plot as an individual file.

## Plot Examples

### Trajectory Plot

The trajectory plot visualizes pseudotime dynamics in phase space, showing the relationship between `x` and `y` variables over time.

```r
plot_trajectory(df, min_x = 0, max_x = 5, min_y = 0, max_y = 5)
```

- **`min_x`, `max_x`**: Set the minimum and maximum limits for the x-axis.
- **`min_y`, `max_y`**: Set the minimum and maximum limits for the y-axis.

### Phase Line Plot

The phase line plot shows summaries across binned data, helping analyze dynamic changes in specific variables.

```r
plot_phase_line(df, input = "standard")
```

- **`input`**: Specifies if the plot should be `"standard"` or `"fraction"`-based.

### Phase Portrait Stream

Stream plots display phase portrait streams to illustrate the direction and magnitude of variable changes over time.

```r
plot_stream(df, bin_width = 5)
```

- **`bin_width`**: Sets the number of bins to group `x` and `y` for streamlines.

**phase.portrait** is well-suited for exploratory data analysis and visual interpretation of complex system dynamics, providing the tools you need to analyze trajectories, streams, and phase portraits efficiently and flexibly.
```
